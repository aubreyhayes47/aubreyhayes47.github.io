<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Submit a Case Brief (Safe — Client-only)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 1.25rem; color:#111; }
    h1 { margin-top: 0; }
    label { display: block; margin: .5rem 0 .25rem; font-weight:600; }
    input[type="text"], input[type="search"], textarea, select { width: 100%; max-width: 900px; padding: .5rem; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; }
    textarea { font-family: inherit; min-height: 10rem; }
    .row { display:flex; gap: .75rem; flex-wrap:wrap; align-items:center; }
    .col { flex: 1 1 220px; min-width: 200px; }
    button { margin-top: .75rem; padding: .5rem .9rem; border-radius:6px; border: 1px solid #bbb; background:#f6f6f6; cursor:pointer; }
    button.primary { background:#0366d6; color:#fff; border-color:#0356b6; }
    .actions { margin-top: .75rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    .preview { margin-top: 1rem; border:1px solid #eee; padding: 1rem; border-radius:6px; background:#fff; max-width:900px; }
    .notes { margin-top: 1rem; color:#555; max-width:900px; }
    .small { font-size:.9rem; color:#666; }
    .help { font-size:.85rem; color:#666; margin-top:.25rem; }
    .danger { color:#b00; font-weight:600; }
    footer { margin-top:2rem; color:#666; font-size:.9rem; }
    .meta-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: .75rem; }
  </style>
  <!-- Using CDN libs for client-side markdown rendering + sanitizing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js" defer></script>
</head>
<body>
  <h1>Submit a Case Brief (Client-only — Safe)</h1>

  <p class="small">This page creates a Markdown (.md) file in your browser. The site never receives any data and no repository credentials are used. After downloading the file, paste it into your repo or create a PR on GitHub.</p>

  <form id="brief-form" onsubmit="return false;">
    <div class="meta-grid">
      <div>
        <label for="course">Course (slug, e.g. contracts)</label>
        <input id="course" name="course" type="text" placeholder="contracts" pattern="[A-Za-z0-9-_]+" required />
        <div class="help">Lowercase; letters, numbers, hyphens or underscores.</div>
      </div>

      <div>
        <label for="filename">Filename (underscores, without .md)</label>
        <input id="filename" name="filename" type="text" placeholder="Smith_v_Jones" pattern="[A-Za-z0-9_\\-]+" required />
        <div class="help">Allowed: letters, numbers, underscores, hyphens. e.g. Smith_v_Jones</div>
      </div>

      <div>
        <label for="title">Case Title</label>
        <input id="title" name="title" type="text" placeholder="Smith v. Jones" required />
      </div>

      <div>
        <label for="citation">Citation (optional)</label>
        <input id="citation" name="citation" type="text" placeholder="456 F.3d 789 (9th Cir. 20XX)" />
      </div>

      <div>
        <label for="court">Court (optional)</label>
        <input id="court" name="court" type="text" placeholder="9th Circuit" />
      </div>

      <div>
        <label for="year">Year (optional)</label>
        <input id="year" name="year" type="text" placeholder="20XX" />
      </div>
    </div>

    <label for="tags">Tags (comma-separated)</label>
    <input id="tags" name="tags" type="text" placeholder="contracts, sale-of-goods" />

    <label for="content">Brief Markdown (first paragraph becomes the index summary)</label>
    <textarea id="content" name="content" placeholder="Paste full brief text in Markdown here..." required></textarea>

    <div class="actions">
      <button id="build-btn" class="primary" type="button">Build & Preview Markdown</button>
      <button id="download-btn" type="button" disabled>Download .md</button>
      <button id="copy-btn" type="button" disabled>Copy Markdown</button>
      <button id="clear-btn" type="button">Clear</button>
    </div>

    <div id="status" class="small" aria-live="polite"></div>
  </form>

  <section class="preview" id="preview" hidden>
    <h3>Preview (sanitized)</h3>
    <div id="rendered"></div>
    <details style="margin-top:.75rem">
      <summary class="small">Show generated Markdown file contents</summary>
      <pre id="md-preview" style="white-space:pre-wrap; max-height:40vh; overflow:auto; padding:.5rem; background:#fafafa; border-radius:6px;"></pre>
    </details>
  </section>

  <section class="notes">
    <p><strong>How to add the file to GitHub:</strong></p>
    <ol>
      <li>Download the .md and save it as <code>briefs/&lt;course&gt;/&lt;filename&gt;.md</code> (e.g., briefs/contracts/Smith_v_Jones.md).</li>
      <li>Open your repo on GitHub, navigate to the <code>briefs/&lt;course&gt;</code> folder (create it if needed), click "Add file" → "Upload files" or "Create new file", and paste the generated markdown.</li>
      <li>Commit to a branch and open a pull request so maintainers can review before merging.</li>
    </ol>
    <p class="small">This client-only workflow avoids storing tokens or accepting uploads server-side — it is the safest option while still being easy to use.</p>
  </section>

  <footer>
    <p>Want an automated PR flow later? I can help build a secure serverless endpoint that creates PRs (requires server-side secrets and authentication).</p>
  </footer>

  <script>
    // Wait for marked & DOMPurify to be available
    (function () {
      const GET_LIB = () => (window.marked && window.DOMPurify) ? Promise.resolve() : new Promise(resolve => {
        const check = () => (window.marked && window.DOMPurify) ? resolve() : setTimeout(check, 50);
        check();
      });

      const el = id => document.getElementById(id);
      const buildYaml = (meta) => {
        // Basic YAML front matter builder: escape quotes in title
        const safe = (s) => (s || '').replace(/"/g, '\\"');
        const lines = [];
        lines.push('---');
        lines.push(`title: "${safe(meta.title)}"`);
        if (meta.citation) lines.push(`citation: "${safe(meta.citation)}"`);
        if (meta.court) lines.push(`court: "${safe(meta.court)}"`);
        if (meta.year) lines.push(`year: ${safe(meta.year)}`);
        lines.push(`permalink: /briefs/${meta.course}/${meta.filename}/`);
        if (meta.tags) {
          const tagsArr = meta.tags.split(',').map(t => t.trim()).filter(Boolean);
          if (tagsArr.length) lines.push('tags: [' + tagsArr.map(t => '"' + t.replace(/"/g,'\\"') + '"').join(', ') + ']');
        }
        lines.push('');
        lines.push(`submitted_at: "${new Date().toISOString()}"`);
        lines.push('---\n');
        return lines.join('\n');
      };

      const normalizeFilename = s => (s || '').trim();

      function setStatus(msg, isError) {
        const status = el('status');
        status.textContent = msg || '';
        status.style.color = isError ? '#b00' : '#333';
      }

      GET_LIB().then(() => {
        const buildBtn = el('build-btn');
        const downloadBtn = el('download-btn');
        const copyBtn = el('copy-btn');
        const clearBtn = el('clear-btn');
        const preview = el('preview');
        const rendered = el('rendered');
        const mdPreview = el('md-preview');

        let lastMd = '';

        buildBtn.addEventListener('click', () => {
          const course = normalizeFilename(el('course').value);
          const filename = normalizeFilename(el('filename').value);
          const title = el('title').value.trim();
          const citation = el('citation').value.trim();
          const court = el('court').value.trim();
          const year = el('year').value.trim();
          const tags = el('tags').value.trim();
          const content = el('content').value;

          if (!course || !filename || !title || !content) {
            setStatus('Please fill Course, Filename, Title, and the Brief text.', true);
            return;
          }
          if (!/^[A-Za-z0-9-_]+$/.test(course) || !/^[A-Za-z0-9_\\-]+$/.test(filename)) {
            setStatus('Invalid characters in course or filename. Use letters, numbers, hyphens, underscores only.', true);
            return;
          }
          if (content.length > 300 * 1024) {
            setStatus('Brief too large. Limit ~300 KB.', true);
            return;
          }

          const meta = { course, filename, title, citation, court, year, tags };
          const front = buildYaml(meta);
          const md = front + (content.trim() + '\n');
          lastMd = md;

          // Render using marked -> sanitize
          try {
            const raw = marked.parse(content);
            const clean = DOMPurify.sanitize(raw);
            rendered.innerHTML = clean;
            mdPreview.textContent = md;
            preview.hidden = false;
            downloadBtn.disabled = false;
            copyBtn.disabled = false;
            setStatus('Preview generated. You can download the .md or copy it to your clipboard.');
          } catch (err) {
            console.error(err);
            setStatus('Error rendering preview: ' + err.message, true);
          }
        });

        downloadBtn.addEventListener('click', () => {
          if (!lastMd) { setStatus('Nothing to download. Click "Build & Preview Markdown" first.', true); return; }
          const course = el('course').value.trim();
          const filename = el('filename').value.trim();
          const blob = new Blob([lastMd], { type: 'text/markdown;charset=utf-8' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `briefs_${course}_${filename}.md`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setStatus('Download started. Save the file as briefs/' + course + '/' + filename + '.md before uploading to GitHub.');
        });

        copyBtn.addEventListener('click', async () => {
          if (!lastMd) { setStatus('Nothing to copy. Click "Build & Preview Markdown" first.', true); return; }
          try {
            await navigator.clipboard.writeText(lastMd);
            setStatus('Markdown copied to clipboard. Paste into GitHub new file or a text editor.');
          } catch (err) {
            setStatus('Clipboard write failed: ' + err.message + '. Use Download instead.', true);
          }
        });

        clearBtn.addEventListener('click', () => {
          el('content').value = '';
          el('title').value = '';
          el('filename').value = '';
          el('course').value = '';
          el('citation').value = '';
          el('court').value = '';
          el('year').value = '';
          el('tags').value = '';
          preview.hidden = true;
          lastMd = '';
          downloadBtn.disabled = true;
          copyBtn.disabled = true;
          setStatus('');
        });
      });
    })();
  </script>
</body>
</html>